version: '3'

x-omnistrate-integrations:
  - omnistrateLogging:
  - omnistrateMetrics:

x-omnistrate-load-balancer:
  https:
    - name: Dashboard
      description: L7 Load Balancer for the Ray Head Node Dashboard
      paths:
        - associatedResourceKey: rayhead
          path: /
          backendPort: 8265

x-omnistrate-service-plan:
  name: 'ray-cluster-mt'
  tenancyType: 'OMNISTRATE_MULTI_TENANCY'

services:
  raycluster:
    image: omnistrate/noop
    depends_on:
      - rayhead
      - rayworker
  rayhead:
    x-omnistrate-compute:
      replicaCount: 1
    x-omnistrate-mode-internal: true
    build:
      context: ./rayhead
      dockerfile: Dockerfile
    command: /bin/sh -c '/start.sh'
    platform: linux/amd64
    deploy:
      resources:
        reservations:
          cpus: "0.5"
          memory: 1G
        limits:
          cpus: "1"
          memory: 4G
    ports:
      - "8265:8265" # Ray Dashboard
      - "6379:6379" # Ray Redis
      - "10001:10001" # Ray Client
  rayworker:
    x-omnistrate-mode-internal: true
    build:
      context: ./rayworker
      dockerfile: Dockerfile
    command: /bin/sh -c '/start.sh'
    platform: linux/amd64
    deploy:
      resources:
        reservations:
          cpus: "0.25"
          memory: 256M
        limits:
          cpus: "0.5"
          memory: 1G
    x-omnistrate-capabilities:
      autoscaling:
        maxReplicas: 5
        minReplicas: 1
        idleMinutesBeforeScalingDown: 2
        idleThreshold: 20
        overUtilizedMinutesBeforeScalingUp: 3
        overUtilizedThreshold: 80
      enableMultiZone: true
  # raygpuworker:
  #   x-omnistrate-compute:
  #     replicaCountAPIParam: numReplicas
  #     instanceTypes:
  #       - cloudProvider: aws
  #         apiParam: instanceType
  #       - cloudProvider: gcp
  #         apiParam: instanceType
  #   x-omnistrate-mode-internal: true
  #   x-omnistrate-capabilities:
  #     enableMultiZone: true
  #   build:
  #     context: ./raygpuworker
  #     dockerfile: Dockerfile
  #   command: /bin/sh -c '/start.sh'
  #   x-omnistrate-api-params:
  #     - key: instanceType
  #       description: Instance Type
  #       name: Instance Type
  #       type: String
  #       modifiable: true
  #       required: true
  #       export: true
  #     - key: numReplicas
  #       description: Number of Replicas
  #       name: Number of Replicas
  #       type: Float64
  #       modifiable: true
  #       required: true
  #       export: true
  hello-world:
    build:
      context: ./jobs/hello-world
      dockerfile: Dockerfile
    environment:
      RAY_ADDRESS: "ray://{{ $var.rayClusterAddress }}:10001"
      SCRIPT_PATH: "submit_job.py"
    deploy:
      resources:
        reservations:
          cpus: "0.1"
          memory: 256M
        limits:
          cpus: "0.5"
          memory: 1G
    privileged: true
    platform: linux/amd64
    volumes:
      - source: ./jobs/hello-world
        target: /app
        type: bind
      - source: ./tmp
        target: /tmp
        type: bind
    x-omnistrate-compute:
      replicaCountApiParam: numReplicas
    x-omnistrate-job-config:
      backoffLimit: 0
      activeDeadlineSeconds: 3600
    x-omnistrate-api-params:
      - key: rayClusterAddress
        description: Ray Cluster Address
        name: Ray Cluster Address
        type: String
        modifiable: true
        required: true
        export: true
      - key: numReplicas
        description: Number of Replicas
        name: Number of Replicas
        type: Float64
        modifiable: true
        required: false
        export: true
        defaultValue: "1"
x-omnistrate-image-registry-attributes:
  ghcr.io:
    auth:
      password: ${{ secrets.GitHubPAT }}
      username: aloknikhil
